---
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
import type { Locale } from '../i18n/utils';
import { getAlternatePath } from '../i18n/utils';

interface Props {
  title: string;
  description?: string;
  lang?: Locale;
  jsonLd?: Record<string, unknown>;
}

const {
  title,
  description = "Developer & AI Specialist",
  lang = 'en',
  jsonLd,
} = Astro.props;

const htmlLang = lang === 'ru' ? 'ru' : 'en-GB';
const ogLocale = lang === 'ru' ? 'ru_RU' : 'en_GB';
const alternate = getAlternatePath(Astro.url.pathname);
const siteUrl = 'https://nickm.dev';
const canonicalUrl = `${siteUrl}${Astro.url.pathname}`;
---

<!doctype html>
<html lang={htmlLang} class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet" />
    <meta name="generator" content={Astro.generator} />
    <meta name="author" content="Nick M" />

    <!-- Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- hreflang -->
    <link rel="alternate" hreflang="en" href={`${siteUrl}${alternate.en}`} />
    <link rel="alternate" hreflang="ru" href={`${siteUrl}${alternate.ru}`} />
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}${alternate.en}`} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:site_name" content="Nick M" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={`${siteUrl}/social-card.png`} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={`${siteUrl}/social-card.png`} />

    <title>{title}</title>
    {jsonLd && (
      <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    )}
    <ViewTransitions />

    <!-- Theme initialization script (runs before page render) -->
    <script is:inline>
      (function() {
        var path = window.location.pathname;
        var html = document.documentElement;

        if (/^\/(ru\/)?notes(\/|$)/.test(path)) {
          html.classList.remove('dark');
        } else if (/^\/(ru\/)?blog(\/|$)/.test(path)) {
          html.classList.add('dark');
        } else {
          var mode = new URLSearchParams(window.location.search).get('mode');
          if (mode === 'personal') {
            html.classList.remove('dark');
          } else {
            html.classList.add('dark');
          }
        }
      })();
    </script>
  </head>
  <body class="flex justify-center bg-background scroll-smooth overflow-x-hidden">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:z-50 focus:px-4 focus:py-2 focus:bg-gold focus:text-background focus:rounded">
      Skip to main content
    </a>
    <main id="main-content" class="flex min-h-screen w-screen max-w-5xl flex-col items-center px-6 pb-10 pt-7 font-garamond text-[0.92rem] leading-relaxed sm:px-10 lg:px-16">
      <div class="flex w-full flex-col gap-y-8">
        <slot />
      </div>

      <!-- Footer Divider -->
      <div class="flex items-center justify-center mt-20">
        <div class="flex items-center gap-4">
          <div class="h-px w-16 bg-gradient-to-r from-transparent to-gold opacity-50"></div>
          <svg width="20" height="20" viewBox="0 0 20 20" class="text-gold opacity-60">
            <circle cx="10" cy="10" r="2" fill="currentColor"></circle>
            <circle cx="10" cy="10" r="6" fill="none" stroke="currentColor" stroke-width="0.5"></circle>
          </svg>
          <div class="h-px w-16 bg-gradient-to-l from-transparent to-gold opacity-50"></div>
        </div>
      </div>
    </main>

    <script>
      // Mode toggle functionality
      function initModeToggle() {
        const flipContainer = document.querySelector('.flip-container');
        const modeToggle = document.getElementById('mode-toggle');
        const html = document.documentElement;

        function toggleMode() {
          html.classList.toggle('dark');
          flipContainer?.classList.toggle('flipped');

          // Toggle visibility of mode-specific content
          document.querySelectorAll('[data-mode]').forEach(el => {
            const elMode = el.getAttribute('data-mode');
            const isDark = html.classList.contains('dark');

            if ((elMode === 'professional' && isDark) || (elMode === 'personal' && !isDark)) {
              (el as HTMLElement).style.display = '';
            } else {
              (el as HTMLElement).style.display = 'none';
            }
          });

          // Update URL
          const newMode = html.classList.contains('dark') ? 'professional' : 'personal';
          const url = new URL(window.location.href);
          url.searchParams.set('mode', newMode);
          window.history.replaceState({}, '', url);
        }

        // Click handlers
        flipContainer?.addEventListener('click', toggleMode);
        modeToggle?.addEventListener('click', toggleMode);

        // Initialize based on URL path or query parameter
        const path = window.location.pathname;
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        if (/^\/(ru\/)?notes(\/|$)/.test(path)) {
          html.classList.remove('dark');
          flipContainer?.classList.add('flipped');
        } else if (/^\/(ru\/)?blog(\/|$)/.test(path)) {
          html.classList.add('dark');
          flipContainer?.classList.remove('flipped');
        } else if (mode === 'personal') {
          html.classList.remove('dark');
          flipContainer?.classList.add('flipped');
        } else {
          html.classList.add('dark');
          flipContainer?.classList.remove('flipped');
        }

        // Set initial visibility
        document.querySelectorAll('[data-mode]').forEach(el => {
          const elMode = el.getAttribute('data-mode');
          const isDark = html.classList.contains('dark');

          if ((elMode === 'professional' && isDark) || (elMode === 'personal' && !isDark)) {
            (el as HTMLElement).style.display = '';
          } else {
            (el as HTMLElement).style.display = 'none';
          }
        });
      }

      // Run on initial load
      document.addEventListener('DOMContentLoaded', initModeToggle);

      // Re-run after Astro page transitions
      document.addEventListener('astro:after-swap', () => {
        const path = window.location.pathname;
        const html = document.documentElement;

        if (/^\/(ru\/)?notes(\/|$)/.test(path)) {
          html.classList.remove('dark');
        } else if (/^\/(ru\/)?blog(\/|$)/.test(path)) {
          html.classList.add('dark');
        } else {
          const mode = new URLSearchParams(window.location.search).get('mode');
          if (mode === 'personal') {
            html.classList.remove('dark');
          } else {
            html.classList.add('dark');
          }
        }

        initModeToggle();
      });
    </script>
  </body>
</html>
