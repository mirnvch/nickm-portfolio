---
import type { Locale } from '../i18n/utils';
import { getAlternatePath } from '../i18n/utils';

interface Props {
  lang: Locale;
}

const { lang } = Astro.props;
const alternate = getAlternatePath(Astro.url.pathname);
const otherLang = lang === 'en' ? 'ru' : 'en';
const otherLabel = lang === 'en' ? 'RU' : 'EN';
const currentLabel = lang === 'en' ? 'EN' : 'RU';
const otherPath = lang === 'en' ? alternate.ru : alternate.en;
---

<div class="lang-switcher flex items-center gap-1 text-sm">
  <span class="flex items-center gap-1 text-foreground font-medium">
    {lang === 'en' ? (
      <svg class="w-4 h-3 rounded-[2px]" viewBox="0 0 60 30" xmlns="http://www.w3.org/2000/svg">
        <clipPath id="gb-cur"><rect width="60" height="30"/></clipPath>
        <g clip-path="url(#gb-cur)">
          <rect width="60" height="30" fill="#012169"/>
          <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
          <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4" clip-path="url(#gb-cur)"/>
          <path d="M30,0 V30 M0,15 H60" stroke="#fff" stroke-width="10"/>
          <path d="M30,0 V30 M0,15 H60" stroke="#C8102E" stroke-width="6"/>
        </g>
      </svg>
    ) : (
      <svg class="w-4 h-3 rounded-[2px]" viewBox="0 0 9 6" xmlns="http://www.w3.org/2000/svg">
        <rect width="9" height="2" fill="#fff"/>
        <rect width="9" height="2" y="2" fill="#0039A6"/>
        <rect width="9" height="2" y="4" fill="#D52B1E"/>
      </svg>
    )}
    {currentLabel}
  </span>
  <span class="text-muted-foreground">/</span>
  <a
    href={otherPath}
    class="flex items-center gap-1 text-muted-foreground hover:text-foreground transition-colors"
    data-lang-switch
  >
    {otherLang === 'ru' ? (
      <svg class="w-4 h-3 rounded-[2px] opacity-60 group-hover:opacity-100" viewBox="0 0 9 6" xmlns="http://www.w3.org/2000/svg">
        <rect width="9" height="2" fill="#fff"/>
        <rect width="9" height="2" y="2" fill="#0039A6"/>
        <rect width="9" height="2" y="4" fill="#D52B1E"/>
      </svg>
    ) : (
      <svg class="w-4 h-3 rounded-[2px] opacity-60 group-hover:opacity-100" viewBox="0 0 60 30" xmlns="http://www.w3.org/2000/svg">
        <clipPath id="gb-alt"><rect width="60" height="30"/></clipPath>
        <g clip-path="url(#gb-alt)">
          <rect width="60" height="30" fill="#012169"/>
          <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
          <path d="M0,0 L60,30 M60,0 L0,30" stroke="#C8102E" stroke-width="4" clip-path="url(#gb-alt)"/>
          <path d="M30,0 V30 M0,15 H60" stroke="#fff" stroke-width="10"/>
          <path d="M30,0 V30 M0,15 H60" stroke="#C8102E" stroke-width="6"/>
        </g>
      </svg>
    )}
    {otherLabel}
  </a>
</div>

<script>
  function initLangSwitcher() {
    const currentMode = new URLSearchParams(window.location.search).get('mode');
    if (!currentMode) return;

    document.querySelectorAll('[data-lang-switch]').forEach(link => {
      const anchor = link as HTMLAnchorElement;
      const url = new URL(anchor.href);
      url.searchParams.set('mode', currentMode);
      anchor.href = url.toString();
    });
  }

  document.addEventListener('DOMContentLoaded', initLangSwitcher);
  document.addEventListener('astro:after-swap', initLangSwitcher);
</script>
